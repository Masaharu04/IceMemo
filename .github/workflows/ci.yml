name: iOS CI (PR only)

on:
  pull_request:
    branches: [ develop, main ]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # PR ã®å ´åˆã€base ãƒ–ãƒ©ãƒ³ãƒã‚‚ä¸€ç·’ã«å–å¾—
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Install tools
        run: |
          brew install swiftlint swift-format
          gem install xcpretty

      - name: Lint & Format (changed Swift files only)
        run: |
          # base ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }} -- '*.swift')
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "âœ… No Swift files changed."
          else
            for file in $CHANGED_FILES; do
              if [ -f "$file" ]; then
                echo "ğŸ§¹ Linting: $file"
                swiftlint --path "$file" || true
                echo "ğŸ¨ Checking format: $file"
                swift-format lint "$file" || true
              fi
            done
          fi

      - name: Build project
        run: |
          xcodebuild -project IceImageMemo.xcodeproj \
            -scheme IceImageMemo \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=18.0' \
            clean build | xcpretty