name: iOS CI (PR only)

on:
  pull_request:
    branches: [ develop, main ]
    paths-ignore:
      - '**/*.md'
      - '.github/**'

jobs:
  build:
    runs-on: macos-latest

    steps:
      # ‚úÖ „É™„Éù„Ç∏„Éà„É™„ÇíÂÖ®Â±•Ê≠¥„Åß„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÔºà--unshallow‰∏çË¶ÅÔºâ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Install dependencies
        run: |
          brew install swiftlint swift-format
          gem install xcpretty

      # ‚úÖ Â∑ÆÂàÜÂèñÂæó„Åó„Å¶Lint/Format
      - name: Run SwiftLint and SwiftFormat on changed files
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          echo "Fetching base branch: $BASE_BRANCH"
          git fetch origin $BASE_BRANCH

          CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD -- '*.swift')
          echo "Changed Swift files:"
          echo "$CHANGED_FILES"

          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No Swift files changed."
          else
            echo "üßπ Running SwiftLint..."
            echo "$CHANGED_FILES" | xargs -I {} swiftlint --path "{}" || true

            echo "üé® Running SwiftFormat..."
            echo "$CHANGED_FILES" | xargs -I {} swift-format lint "{}" || true
          fi

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-${{ hashFiles('**/*.xcodeproj/**', '**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-xcode-

      - name: Build project
        run: |
          set -o pipefail && \
          xcodebuild -project IceImageMemo.xcodeproj \
            -scheme IceImageMemo \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=18.0' \
            clean build | tee xcodebuild.log | xcpretty
